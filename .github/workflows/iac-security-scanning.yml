name: Infrastructure Security Scanning

on:
  push:
    branches: [ main ]
    paths:
      - '**.bicep'
      - '.github/workflows/iac-security-scanning.yml'
  pull_request:
    branches: [ main ]
    paths:
      - '**.bicep'
  workflow_dispatch:

permissions:
  contents: read
  security-events: write  # Required for SARIF upload to Security tab

jobs:
  checkov-scan:
    name: Checkov IaC Security Scan
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Checkov
        run: |
          pip install checkov==3.2.489
          checkov --version
      
      - name: Run Checkov scan (SARIF output)
        run: |
          checkov \
            --directory azure-security-mastery \
            --framework bicep \
            --output sarif \
            --output-file-path . \
            --output-bc-ids \
            --soft-fail
        continue-on-error: true
      
      - name: Rename SARIF file
        run: |
          ls -la *.sarif || echo "No SARIF files found"
          # Checkov creates results_sarif.sarif, rename to results.sarif
          if [ -f results_sarif.sarif ]; then
            mv results_sarif.sarif results.sarif
          fi
          cat results.sarif | head -50  # Debug: show first 50 lines
      
      - name: Upload SARIF to GitHub Security Tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif
          category: checkov-iac
      
      - name: Upload SARIF as artifact (for review)
        uses: actions/upload-artifact@v4
        with:
          name: checkov-sarif-results
          path: results.sarif
          retention-days: 30
      
      - name: Display scan summary
        run: |
          echo "ğŸ“Š Checkov Security Scan Complete!"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          if [ -f results.sarif ]; then
            TOTAL=$(jq '[.runs[].results[]] | length' results.sarif)
            echo "Total issues found: $TOTAL"
            echo ""
            echo "View detailed results:"
            echo "â†’ GitHub Security tab: https://github.com/${{ github.repository }}/security/code-scanning"
            echo "â†’ Workflow artifacts: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          else
            echo "âš ï¸  SARIF file not generated"
          fi
